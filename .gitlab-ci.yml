## Rename this file to .gitlab-ci.yml
stages:
  - build
  - lint
  - test  # ✅ Added test stage

# BUILD STAGE
build-backend:
  stage: build
  image: gradle:7.5-jdk17
  script:
    - cd backend
    - gradle clean build -x test -x check
  rules:
    - when: always
  allow_failure: false

# LINT STAGE
lint-backend:
  stage: lint
  image: gradle:7.5-jdk17
  script:
    - cd backend
    - gradle check
  rules:
    - when: always
  allow_failure: false

lint-frontend:
  stage: lint
  image: node:16
  script:
    - cd frontend
    - npm install
    - npx eslint . --ext .js,.jsx
  rules:
    - when: always
  allow_failure: false

# TEST STAGE
test-python:
  stage: test
  image: python:3.12  
  before_script:
    - cd ingestor  
    - pip install --upgrade pip
    - pip install pytest coverage  
    - pip install -r requirements.txt 
  script:
    - coverage run -m pytest tests/test.py  
    - coverage report -m  
  rules:
    - when: always
  allow_failure: false

test-frontend:
  stage: test
  image: node:16
  before_script:
    - cd frontend
    - npm install
  script:
    - npm test -- --watchAll=false
    - npm test -- --coverage --watchAll=false  # Run tests with coverage
  rules:
    - when: always
  allow_failure: false

test-backend:
  stage: test
  image: gradle:7.5-jdk17
  script:
    - cd backend
    - chmod +x gradlew
    - ./gradlew test jacocoTestReport
    - echo "Coverage Report:"
    - cat build/reports/jacoco/test/jacocoTestReport.xml | grep -A 2 '<counter type="LINE"'  # ✅ Extract coverage summary
  rules:
    - when: always
  allow_failure: false


